<UserControl x:Class="TaskManagerPro.Views.ProcessListView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:converters="clr-namespace:TaskManagerPro.Converters">
    <UserControl.Resources>
        <converters:BytesToStringConverter x:Key="BytesConverter"/>
        <converters:CpuPercentConverter x:Key="CpuConverter"/>
        <converters:ThreatLevelToColorConverter x:Key="ThreatColorConverter"/>
    </UserControl.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Search Bar -->
        <Grid Grid.Row="0" Margin="8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <TextBox Grid.Column="0" Text="{Binding SearchFilter, UpdateSourceTrigger=PropertyChanged}"
                     VerticalContentAlignment="Center"/>
            <Button Grid.Column="1" Content="Scan Selected" Command="{Binding ScanSelectedProcessCommand}"
                    Margin="8,0,0,0" Background="#10B981"/>
            <Button Grid.Column="2" Content="Refresh" Command="{Binding RefreshProcessesCommand}" Margin="8,0,0,0"/>
        </Grid>

        <!-- Process DataGrid -->
        <DataGrid Grid.Row="1" ItemsSource="{Binding FilteredProcesses}"
                  SelectedItem="{Binding SelectedProcess}"
                  VirtualizingPanel.IsVirtualizing="True"
                  VirtualizingPanel.VirtualizationMode="Recycling"
                  EnableRowVirtualization="True">
            <DataGrid.ContextMenu>
                <ContextMenu>
                    <MenuItem Header="Kill Process" Command="{Binding KillProcessCommand}"/>
                    <MenuItem Header="Suspend" Command="{Binding SuspendProcessCommand}"/>
                    <MenuItem Header="Resume" Command="{Binding ResumeProcessCommand}"/>
                    <Separator/>
                    <MenuItem Header="Scan for Threats" Command="{Binding ScanSelectedProcessCommand}"/>
                </ContextMenu>
            </DataGrid.ContextMenu>
            <DataGrid.Columns>
                <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="160" />
                <DataGridTextColumn Header="PID" Binding="{Binding Pid}" Width="60"/>
                <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="80"/>
                <DataGridTextColumn Header="CPU %" Binding="{Binding CpuPercent, Converter={StaticResource CpuConverter}}" Width="70"/>
                <DataGridTextColumn Header="Memory" Binding="{Binding WorkingSetBytes, Converter={StaticResource BytesConverter}}" Width="80"/>
                <DataGridTextColumn Header="Threads" Binding="{Binding ThreadCount}" Width="60"/>
                <DataGridTextColumn Header="Description" Binding="{Binding FileDescription}" Width="200"/>
                <DataGridTextColumn Header="Company" Binding="{Binding CompanyName}" Width="140"/>
                <DataGridTemplateColumn Header="Threat" Width="80" SortMemberPath="ThreatLevel">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Border Background="{Binding ThreatLevel, Converter={StaticResource ThreatColorConverter}}"
                                    CornerRadius="3" Padding="4,2" HorizontalAlignment="Center">
                                <TextBlock Text="{Binding ThreatLevel}" Foreground="White" FontSize="11"/>
                            </Border>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>

        <!-- Detail Panel -->
        <Expander Grid.Row="2" Header="Process Details" IsExpanded="False"
                  Background="{StaticResource SurfaceBrush}" Foreground="{StaticResource TextBrush}"
                  Visibility="{Binding SelectedProcess, Converter={StaticResource BoolToVisConverter}, ConverterParameter=notnull}"
                  MaxHeight="200">
            <ScrollViewer VerticalScrollBarVisibility="Auto" Margin="8">
                <StackPanel>
                    <TextBlock Text="{Binding SelectedProcess.ImagePath, StringFormat='Path: {0}'}" TextWrapping="Wrap"/>
                    <TextBlock Text="{Binding SelectedProcess.CommandLine, StringFormat='Command: {0}'}" TextWrapping="Wrap" Margin="0,4,0,0"/>
                    <TextBlock Text="{Binding SelectedProcess.PriorityClass, StringFormat='Priority: {0}'}" Margin="0,4,0,0"/>
                    <TextBlock Text="{Binding SelectedProcess.StartTime, StringFormat='Started: {0}'}" Margin="0,4,0,0"/>
                </StackPanel>
            </ScrollViewer>
        </Expander>
    </Grid>
</UserControl>
